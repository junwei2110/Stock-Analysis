CREATE TRIGGER trg_AfterInsert_AuditLog
ON AuditLog
AFTER INSERT
AS
BEGIN
    -- Step 1: Create a temporary table to store the inserted data
    CREATE TABLE #TempInserted (
        ID INT,
        AuditCode NVARCHAR(10),
        ActionDescription NVARCHAR(255)
    );

    -- Step 2: Insert the data from the INSERTED pseudo-table into the temp table
    INSERT INTO #TempInserted (ID, AuditCode, ActionDescription)
    SELECT ID, AuditCode, ActionDescription
    FROM INSERTED;

    -- Declare variables for dynamic SQL
    DECLARE @DynamicSQL NVARCHAR(MAX);
    DECLARE @ColumnName NVARCHAR(128) = 'ActionDescription';
    DECLARE @ColumnValue NVARCHAR(255);
    DECLARE @ID INT;

    -- Step 3: Construct and execute dynamic SQL to query the temporary table
    SET @DynamicSQL = 'SELECT @Value = ' + @ColumnName + ' FROM #TempInserted WHERE ID = @IDParam';

    -- Fetch the ID from the temporary table (could loop through for multiple rows)
    SELECT @ID = ID FROM #TempInserted;

    -- Execute the dynamic SQL to get the value from the temporary table
    EXEC sp_executesql @DynamicSQL, N'@Value NVARCHAR(255) OUTPUT, @IDParam INT', @Value = @ColumnValue OUTPUT, @IDParam = @ID;

    -- Print the result for debugging purposes
    PRINT 'Retrieved Value: ' + @ColumnValue;

    -- Drop the temporary table (optional as it's dropped automatically at the end of the session)
    DROP TABLE #TempInserted;
END;
